---
import { Icon } from "astro-icon/components";
import { siteConfig, umamiConfig } from "../../config";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import {
	getCategoryList,
	getSortedPosts,
	getTagList,
} from "../../utils/content-utils";
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
	class?: string;
	style?: string;
}

const { class: className, style } = Astro.props;

// 从配置中获取站点开始日期
const siteStartDate = siteConfig.siteStartDate || "2025-01-01";

// 获取所有文章
const posts = await getSortedPosts();
const categories = await getCategoryList();
const tags = await getTagList();

// 计算总字数
let totalWords = 0;
for (const post of posts) {
	if (post.body) {
		// 移除 Markdown 空白字符后计算字数
		const text = post.body
			.replace(/\s+/g, " ") // 合并空白
			.trim();

		// 分别计算中文字符和英文单词
		const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || [];
		const englishWords = text.match(/[a-zA-Z]+/g) || [];

		totalWords += chineseChars.length + englishWords.length;
	}
}

// 格式化数字（添加千位分隔符）
function formatNumber(num: number): string {
	return num.toLocaleString();
}

// 获取最新文章日期（忽略置顶状态，只按发布日期排序）
const latestPost = posts.reduce((latest, post) => {
	if (!latest) return post;
	return post.data.published > latest.data.published ? post : latest;
}, posts[0]);

const lastPostDate = latestPost
	? latestPost.data.published.toISOString()
	: null;

const stats = [
	{
		icon: "material-symbols:article-outline",
		label: i18n(I18nKey.siteStatsPostCount),
		value: posts.length,
	},
	{
		icon: "material-symbols:folder-outline",
		label: i18n(I18nKey.siteStatsCategoryCount),
		value: categories.length,
	},
	{
		icon: "material-symbols:label-outline",
		label: i18n(I18nKey.siteStatsTagCount),
		value: tags.length,
	},
	{
		icon: "material-symbols:text-ad-outline-rounded",
		label: i18n(I18nKey.siteStatsTotalWords),
		value: totalWords,
		formatted: true,
	},
	{
		icon: "material-symbols:calendar-clock-outline",
		label: i18n(I18nKey.siteStatsRunningDays),
		value: 0, // 将由客户端更新
		suffix: i18n(I18nKey.siteStatsDays).replace("{days}", ""),
		dynamic: true,
		id: "running-days",
	},
	{
		icon: "material-symbols:ecg-heart-outline",
		label: i18n(I18nKey.siteStatsLastUpdate),
		value: 0, // 将由客户端更新
		suffix: i18n(I18nKey.siteStatsDaysAgo).replace("{days}", ""),
		dynamic: true,
		id: "last-update",
	},
];

// 如果启用了Umami，添加Umami统计数据
const showUmamiStats = umamiConfig.enabled && umamiConfig.shareUrl && umamiConfig.websiteId;
---

<WidgetLayout name={i18n(I18nKey.siteStats)} id="site-stats" class={className} style={style}>
  <div class="flex flex-col gap-2">
    {stats.map((stat) => (
      <div class="flex items-center justify-between px-3 py-1.5">
        <div class="flex items-center gap-2.5">
          <div class="text-[var(--primary)] text-xl">
            <Icon name={stat.icon} />
          </div>
          <span class="text-neutral-700 dark:text-neutral-300 font-medium text-sm">
            {stat.label}
          </span>
        </div>
        <div class="flex items-center">
          <span 
            class="text-base font-bold text-neutral-900 dark:text-neutral-100"
            data-stat-id={stat.id}
          >
            {stat.formatted ? formatNumber(stat.value) : stat.value}
          </span>
          {stat.suffix && (
            <span class="text-sm text-neutral-500 dark:text-neutral-400 ml-1">
              {stat.suffix}
            </span>
          )}
        </div>
      </div>
    ))}
    
    {/* Umami统计显示区域 */}
    {showUmamiStats && (
      <div class="border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
        <div class="text-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Umami 统计
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div class="text-center">
            <div class="text-lg font-bold text-blue-600 dark:text-blue-400" id="umami-pageviews">-</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">页面浏览</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-green-600 dark:text-green-400" id="umami-visitors">-</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">访客数</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-purple-600 dark:text-purple-400" id="umami-visits">-</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">访问数</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-orange-600 dark:text-orange-400" id="umami-bounces">-</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">跳出数</div>
          </div>
        </div>
      </div>
    )}
  </div>
</WidgetLayout>

<script is:inline define:vars={{ siteStartDate, lastPostDate, umamiConfig }}>
  function updateDynamicStats() {
    const today = new Date();
    
    // 更新运行天数
    const startDate = new Date(siteStartDate);
    const diffTime = Math.abs(today.getTime() - startDate.getTime());
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    const runningDaysElement = document.querySelector('[data-stat-id="running-days"]');
    if (runningDaysElement) {
      runningDaysElement.textContent = diffDays.toString();
    }
    
    // 更新最后活动时间
    if (lastPostDate) {
      const lastPost = new Date(lastPostDate);
      const timeSinceLastPost = Math.abs(today.getTime() - lastPost.getTime());
      const daysSinceLastUpdate = Math.floor(timeSinceLastPost / (1000 * 60 * 60 * 24));
      
      const lastUpdateElement = document.querySelector('[data-stat-id="last-update"]');
      if (lastUpdateElement) {
        lastUpdateElement.textContent = daysSinceLastUpdate.toString();
      }
    }
  }
  
  // 页面加载时更新
  updateDynamicStats();
  
  // 每小时更新一次（可选，因为天数变化较慢）
  setInterval(updateDynamicStats, 60 * 60 * 1000);
  
  // 如果启用了Umami，获取统计数据
  if (typeof window !== 'undefined' && window.getUmamiWebsiteStatsFromShare) {
    window.getUmamiWebsiteStatsFromShare(
      umamiConfig.shareUrl,
      umamiConfig.websiteId
    )
    .then(stats => {
      document.getElementById('umami-pageviews').textContent = stats.pageviews || '-';
      document.getElementById('umami-visitors').textContent = stats.visitors || '-';
      document.getElementById('umami-visits').textContent = stats.visits || '-';
      document.getElementById('umami-bounces').textContent = stats.bounces || '-';
    })
    .catch(error => {
      console.error('获取Umami统计数据失败:', error);
      document.getElementById('umami-pageviews').textContent = 'N/A';
      document.getElementById('umami-visitors').textContent = 'N/A';
      document.getElementById('umami-visits').textContent = 'N/A';
      document.getElementById('umami-bounces').textContent = 'N/A';
    });
  }
</script>